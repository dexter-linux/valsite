<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Whispers - Messages</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <!-- PapaParse for reliable CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="aquarium-bg"></div>
    <div id="loginSection" class="login-overlay">
        <div class="container" style="max-width: 350px; padding: 30px; background: rgba(255,255,255,0.95); border-radius: 20px;">
            <h1 style="font-family: 'Great Vibes'; font-size: 3rem; color: #d81b60; margin-bottom: 10px;">MIDARA</h1>
            <p style="margin-bottom: 20px; color: #666;">Unlock our whispers, love.</p>
           
            <select id="userSelect" style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ffb6c1; background: white;">
                <option value="" disabled selected>Who are you?</option>
                <option value="Mideva">Mideva</option>
                <option value="Gachara">Gachara</option>
            </select>
            <input type="password" id="passInput" placeholder="Secret Code" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 10px; border: 1px solid #ffb6c1;">
           
            <button onclick="checkLogin()" class="modal-btn" style="width: 100%; background: #ff69b4; color: white; border: none; padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold;">Enter the Deep ‚ú®</button>
            <p id="loginError" style="color: #d81b60; font-size: 0.85rem; margin-top: 15px; display: none;">That's not our code, pearl. ‚ù§Ô∏è</p>
        </div>
    </div>

    <div class="container" id="chatInterface" style="display:none; max-width: 600px; height: 90vh; display: flex; flex-direction: column; background: rgba(255,255,255,0.9); border-radius: 20px; padding: 20px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="welcomeUser" style="font-family: 'Great Vibes'; font-size: 2.5rem; color: #d81b60; margin: 0;"></h2>
            <button onclick="logout()" style="background: none; border: none; color: #d81b60; cursor: pointer; text-decoration: underline;">Logout</button>
        </header>
       
        <div class="chat-box" id="chatBox" style="flex-grow: 1; overflow-y: auto; background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #fce4ec;">
            <p style="text-align: center; color: #ff69b4; font-style: italic;">Sifting through the tides...</p>
        </div>
       
        <div class="input-area" style="background: #fff5f7; padding: 15px; border-radius: 15px;">
            <input type="text" id="msgInput" placeholder="Write a whisper..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ffb6c1; margin-bottom: 10px;">
            <input type="text" id="attachInput" placeholder="File path (e.g., images/us.jpg)" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #fff; font-size: 0.8rem; margin-bottom: 10px;">
            <button onclick="sendMessage()" id="sendBtn" style="width: 100%; background: #ff69b4; color: white; border: none; padding: 12px; border-radius: 20px; cursor: pointer; font-weight: bold;">Send Whisper üåä</button>
        </div>
        <a href="index.html" class="nav-link" style="text-align: center; display: block; margin-top: 10px;">‚Üê Back Home</a>
    </div>

    <script>
        const PASSWORDS = { "Mideva": "lavender2026", "Gachara": "gachara2026" };
       
        // --- GOOGLE FORM CONFIG ---
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse";
        const ENTRY_SENDER = "entry.111111";
        const ENTRY_MESSAGE = "entry.222222";
        const ENTRY_ATTACH = "entry.333333";
        // Optional: Add timestamp field in your form ‚Üí entry.xxxxxxx
        // const ENTRY_TIMESTAMP = "entry.xxxxxxx";

        // --- YOUR SPREADSHEET PUBLISHED CSV LINK ---
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQzoKVF_bSr6HWRrmnjlcwHie_OAfinkk4YBkDfWtDnoJ6yyNQSactFMqvqc0Hmy4N3JQGqN_gVqpbU/pub?output=csv";

        let currentUser = "";

        function checkLogin() {
            const user = document.getElementById('userSelect').value;
            const pass = document.getElementById('passInput').value;
            const error = document.getElementById('loginError');
            if (user && PASSWORDS[user] === pass) {
                currentUser = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('welcomeUser').innerText = "For " + user;
                loadMessages();
                setInterval(loadMessages, 8000);
            } else {
                error.style.display = 'block';
                document.getElementById('passInput').value = "";
            }
        }

        async function sendMessage() {
            const text = document.getElementById('msgInput').value.trim();
            const attach = document.getElementById('attachInput').value.trim();
            const btn = document.getElementById('sendBtn');
            if (!text && !attach) return;

            btn.disabled = true;
            btn.innerText = "Sending...";

            const formData = new FormData();
            formData.append(ENTRY_SENDER, currentUser);
            formData.append(ENTRY_MESSAGE, text);
            formData.append(ENTRY_ATTACH, attach);
            // Optional: formData.append(ENTRY_TIMESTAMP, new Date().toISOString());

            try {
                await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                document.getElementById('msgInput').value = "";
                document.getElementById('attachInput').value = "";
                loadMessages(); // Immediate refresh
            } catch (e) {
                console.error("Submission error", e);
                alert("Whisper sent into the void... but it might still arrive later üåä");
            } finally {
                btn.disabled = false;
                btn.innerText = "Send Whisper üåä";
            }
        }

        async function loadMessages() {
            try {
                const res = await fetch(SHEET_CSV_URL + "?cb=" + Date.now());
                const csvText = await res.text();

                // Using PapaParse ‚Äì super reliable!
                const parsed = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    trimHeaders: true
                });

                const box = document.getElementById('chatBox');
                box.innerHTML = "";

                // Reverse to show newest first (optional ‚Äì remove if you want oldest first)
                const rows = parsed.data.reverse();

                rows.forEach(row => {
                    const sender = (row.sender || row.Sender || "").trim();
                    const message = (row.message || row.Message || "").trim();
                    const attachment = (row.attachment || row.Attachment || row.attach || "").trim();
                    const timestamp = row.timestamp || row.Timestamp || "";

                    if (!sender && !message) return; // skip completely empty rows

                    const msgDiv = document.createElement('div');
                    msgDiv.style.maxWidth = "85%";
                    msgDiv.style.padding = "12px";
                    msgDiv.style.borderRadius = "18px";
                    msgDiv.style.fontSize = "0.95rem";
                    msgDiv.style.boxShadow = "0 2px 8px rgba(0,0,0,0.08)";
                    msgDiv.style.marginBottom = "8px";
                    msgDiv.style.wordWrap = "break-word";

                    if (sender === currentUser) {
                        msgDiv.style.alignSelf = "flex-end";
                        msgDiv.style.background = "linear-gradient(135deg, #ff69b4, #ff8cc4)";
                        msgDiv.style.color = "white";
                        msgDiv.style.borderBottomRightRadius = "4px";
                    } else {
                        msgDiv.style.alignSelf = "flex-start";
                        msgDiv.style.backgroundColor = "#ffffff";
                        msgDiv.style.border = "1px solid #ffb6c1";
                        msgDiv.style.color = "#444";
                        msgDiv.style.borderBottomLeftRadius = "4px";
                    }

                    let content = `<div style="font-weight:500; margin-bottom:4px;">${sender}</div>`;
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        content += `<div style="font-size:0.75rem; opacity:0.8; margin-bottom:6px;">${timeStr}</div>`;
                    }
                    content += `<div>${message.replace(/\n/g, '<br>')}</div>`;

                    if (attachment) {
                        if (attachment.toLowerCase().includes('.mp4') || attachment.toLowerCase().includes('.webm')) {
                            content += `<video src="${attachment}" controls style="width:100%; max-width:300px; margin-top:10px; border-radius:12px;"></video>`;
                        } else if (attachment.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp)$/i)) {
                            content += `<img src="${attachment}" style="width:100%; max-width:320px; margin-top:10px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="color:#aaa; font-size:0.8rem; margin-top:4px; display:none;">Image not found ‚ô°</div>`;
                        } else {
                            content += `<a href="${attachment}" target="_blank" style="color:#ff69b4; text-decoration:underline; font-size:0.85rem; margin-top:8px; display:inline-block;">Open attachment ‚Üó</a>`;
                        }
                    }

                    msgDiv.innerHTML = content;
                    box.appendChild(msgDiv);
                });

                box.scrollTop = box.scrollHeight;

            } catch (e) {
                console.error("Failed to load messages:", e);
                document.getElementById('chatBox').innerHTML = "<p style='color:#d81b60; text-align:center;'>The ocean is quiet for now... try again soon ‚ô°</p>";
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
