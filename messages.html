<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Whispers - Messages</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="aquarium-bg"></div>

    <div id="loginSection" class="login-overlay">
        <div class="container" style="max-width: 350px; padding: 30px; background: rgba(255,255,255,0.95); border-radius: 20px;">
            <h1 style="font-family: 'Great Vibes'; font-size: 3rem; color: #d81b60; margin-bottom: 10px;">MIDARA</h1>
            <p style="margin-bottom: 20px; color: #666;">Unlock our whispers, love.</p>
           
            <select id="userSelect" style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ffb6c1; background: white;">
                <option value="" disabled selected>Who are you?</option>
                <option value="Mideva">Mideva</option>
                <option value="Gachara">Gachara</option>
            </select>
            <input type="password" id="passInput" placeholder="Secret Code" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 10px; border: 1px solid #ffb6c1;">
           
            <button onclick="checkLogin()" class="modal-btn" style="width: 100%; background: #ff69b4; color: white; border: none; padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold;">Enter the Deep ‚ú®</button>
            <p id="loginError" style="color: #d81b60; font-size: 0.85rem; margin-top: 15px; display: none;">That's not our code, pearl. ‚ù§Ô∏è</p>
        </div>
    </div>

    <div class="container" id="chatInterface" style="display:none; max-width: 600px; height: 90vh; display: flex; flex-direction: column; background: rgba(255,255,255,0.9); border-radius: 20px; padding: 20px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="welcomeUser" style="font-family: 'Great Vibes'; font-size: 2.5rem; color: #d81b60; margin: 0;"></h2>
            <div>
                <button onclick="loadMessages()" style="background:none;border:none;color:#d81b60;cursor:pointer;text-decoration:underline;margin-right:15px;font-size:0.9rem;">Refresh ‚ôªÔ∏è</button>
                <button onclick="logout()" style="background:none;border:none;color:#d81b60;cursor:pointer;text-decoration:underline;">Logout</button>
            </div>
        </header>
       
        <div class="chat-box" id="chatBox" style="flex-grow: 1; overflow-y: auto; background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #fce4ec;">
            <p style="text-align: center; color: #ff69b4; font-style: italic;">Sifting through the tides...</p>
        </div>
       
        <div class="input-area" style="background: #fff5f7; padding: 15px; border-radius: 15px;">
            <input type="text" id="msgInput" placeholder="Write a whisper..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ffb6c1; margin-bottom: 10px;">
            <input type="text" id="attachInput" placeholder="Attachment URL (e.g. https://raw.githubusercontent.com/.../us.jpg)" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ffb6c1; font-size: 0.8rem; margin-bottom: 10px;">
            <button onclick="sendMessage()" id="sendBtn" style="width: 100%; background: #ff69b4; color: white; border: none; padding: 12px; border-radius: 20px; cursor: pointer; font-weight: bold;">Send Whisper üåä</button>
        </div>
        <a href="index.html" class="nav-link" style="text-align: center; display: block; margin-top: 10px;">‚Üê Back Home</a>
    </div>

    <script>
        const PASSWORDS = { "Mideva": "lavender2026", "Gachara": "gachara2026" };
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdVG70G7V-NzGqCdtwOe2xuMmLUhtjQTJpbcJ5OBwU4KZnEiw/formResponse";
        const ENTRY_SENDER    = "entry.235096891";
        const ENTRY_MESSAGE   = "entry.262317851";
        const ENTRY_ATTACH    = "entry.1055245339";

        // Using allorigins.win proxy (no activation needed)
        const GOOGLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQzoKVF_bSr6HWRrmnjlcwHie_OAfinkk4YBkDfWtDnoJ6yyNQSactFMqvqc0Hmy4N3JQGqN_gVqpbU/pub?output=csv";
        const SHEET_CSV_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(GOOGLE_CSV_URL);

        let currentUser = "";

        function checkLogin() {
            const user = document.getElementById('userSelect').value;
            const pass = document.getElementById('passInput').value;
            if (user && PASSWORDS[user] === pass) {
                currentUser = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'flex';
                document.getElementById('welcomeUser').innerText = "For " + user;
                loadMessages();
                setInterval(loadMessages, 600000); // auto-refresh every 60 seconds
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passInput').value = "";
            }
        }

        async function sendMessage() {
            const text = document.getElementById('msgInput').value.trim();
            const attach = document.getElementById('attachInput').value.trim();
            const btn = document.getElementById('sendBtn');

            if (!text && !attach) return;

            btn.disabled = true;
            btn.innerText = "Sending...";

            const formData = new FormData();
            formData.append(ENTRY_SENDER, currentUser);
            formData.append(ENTRY_MESSAGE, text || " ");
            formData.append(ENTRY_ATTACH, attach);

            try {
                await fetch(GOOGLE_FORM_URL, { method: 'POST', mode: 'no-cors', body: formData });
                document.getElementById('msgInput').value = "";
                document.getElementById('attachInput').value = "";
                document.getElementById('chatBox').innerHTML = '<p style="text-align:center;color:#ff69b4;font-style:italic;">Whisper sent! Loading updates soon... üåä</p>';
                setTimeout(loadMessages, 6000); // give Google Forms time to process
            } catch (err) {
                console.error("Send error:", err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Send Whisper üåä";
            }
        }

        async function loadMessages() {
            const box = document.getElementById('chatBox');
            box.innerHTML = '<p style="text-align:center;color:#ff69b4;font-style:italic;">Loading whispers from the deep...</p>';

            try {
                // Add cache-busting timestamp
                const urlWithCacheBust = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + "t=" + Date.now();
                const res = await fetch(urlWithCacheBust);

                if (!res.ok) {
                    throw new Error(`Proxy responded with HTTP ${res.status}`);
                }

                const csvText = await res.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });

                box.innerHTML = "";

                if (parsed.data.length === 0 || parsed.data.every(row => !row.Sender?.trim())) {
                    box.innerHTML = "<p style='text-align:center;color:#ff69b4;'>No whispers yet... be the first to send one ‚ô°</p>";
                    return;
                }

                parsed.data.forEach(row => {
                    const sender = (row.Sender || "").trim();
                    const message = (row.Message || "").trim();
                    const attachment = (row.Attachment || "").trim();
                    const timestamp = row.Timestamp || "";

                    if (!sender) return;

                    const msgDiv = document.createElement('div');
                    msgDiv.style.maxWidth = "85%";
                    msgDiv.style.padding = "12px 16px";
                    msgDiv.style.borderRadius = "18px";
                    msgDiv.style.fontSize = "0.95rem";
                    msgDiv.style.boxShadow = "0 2px 8px rgba(0,0,0,0.08)";
                    msgDiv.style.marginBottom = "8px";
                    msgDiv.style.alignSelf = sender === currentUser ? "flex-end" : "flex-start";
                    msgDiv.style.background = sender === currentUser 
                        ? "linear-gradient(135deg, #ff69b4, #ff8cc4)" 
                        : "#ffffff";
                    msgDiv.style.color = sender === currentUser ? "white" : "#333";
                    msgDiv.style.border = sender === currentUser ? "none" : "1px solid #ffb6c1";
                    msgDiv.style.borderBottomRightRadius = sender === currentUser ? "4px" : "18px";
                    msgDiv.style.borderBottomLeftRadius = sender !== currentUser ? "4px" : "18px";

                    let content = `<strong>${sender}</strong>`;
                    if (timestamp) {
                        const date = new Date(timestamp);
                        content += `<br><small style="opacity:0.8;">${date.toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'})}</small>`;
                    }
                    if (message && message !== " ") content += `<br>${message.replace(/\n/g, '<br>')}`;
                    if (attachment) {
                        const l = attachment.toLowerCase();
                        if (l.endsWith('.mp4') || l.endsWith('.webm') || l.endsWith('.mov')) {
                            content += `<video src="${attachment}" controls style="width:100%;max-width:320px;margin-top:8px;border-radius:12px;"></video>`;
                        } else if (/\.(jpg|jpeg|png|gif|webp)$/i.test(l)) {
                            content += `<img src="${attachment}" style="width:100%;max-width:320px;margin-top:8px;border-radius:12px;" onerror="this.onerror=null;this.src='https://via.placeholder.com/320?text=Image+Not+Found';">`;
                        } else {
                            content += `<br><a href="${attachment}" target="_blank" style="color:#ff69b4;">Open attachment ‚Üó</a>`;
                        }
                    }

                    msgDiv.innerHTML = content;
                    box.appendChild(msgDiv);
                });

                box.scrollTop = box.scrollHeight;
            } catch (e) {
                console.error("Load error:", e);
                box.innerHTML = `<p style="text-align:center;color:#d81b60;">
                    Couldn't load whispers...<br>
                    (Possible issues: proxy down, network, or Google delay)<br>
                    Try Refresh button or check browser console (F12).<br>üåä
                </p>`;
            }
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
